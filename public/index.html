<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Simulation Controller</title>
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: #f8f9fa;
            color: #212529;
            padding: 20px;
        }

        h1,
        h2 {
            text-align: center;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-section {
            border: 1px solid #e9ecef;
            padding: 15px;
            border-radius: 5px;
        }

        .form-section h3 {
            margin-top: 0;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            font-weight: 500;
            margin-bottom: 5px;
        }

        input,
        textarea {
            width: 95%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }

        button {
            display: block;
            width: 100%;
            padding: 12px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: #0056b3;
        }

        #api-result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            background-color: #e9ecef;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: monospace;
            transition: all 0.3s ease;
        }

        .mode-selection {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none !important;
        }

        .mode-selection h3 {
            color: white;
        }

        .mode-option {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            transition: background 0.2s;
        }

        .mode-option:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .mode-option input[type="radio"] {
            margin-right: 8px;
        }

        .mode-option small {
            display: block;
            margin-top: 5px;
            opacity: 0.9;
        }

        .security-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 8px;
        }

        .secure {
            background: #28a745;
            color: white;
        }

        .less-secure {
            background: #ffc107;
            color: #212529;
        }
    </style>
</head>

<body>

    <div class="container">
        <h1>Payment Simulation Controller</h1>

        <!-- Mode Selection -->
        <div class="form-section mode-selection" style="margin-bottom: 20px;">
            <h3>üîß Transaction Mode</h3>
            <div class="mode-option">
                <label>
                    <input type="radio" name="transaction-type" value="simulation" checked>
                    <strong>Simulation Mode</strong>
                    <span class="security-badge less-secure">SIMULATION</span>
                </label>
                <small>
                    üé≠ Mock transactions for testing. No real money involved.
                </small>
            </div>
            <div class="mode-option">
                <label>
                    <input type="radio" name="transaction-type" value="real">
                    <strong>Real Transaction Mode</strong>
                    <span class="security-badge secure">REAL MONEY</span>
                </label>
                <small>
                    üí∞ Real Stripe API calls. Actual money will be processed!
                </small>
            </div>
        </div>

        <div class="form-section mode-selection" style="margin-bottom: 20px;">
            <h3>üîß Payment Mode</h3>
            <div class="mode-option">
                <label>
                    <input type="radio" name="mode" value="direct" checked>
                    <strong>Direct Mode</strong>
                    <span class="security-badge less-secure">LESS SECURE</span>
                </label>
                <small>
                    ‚ö†Ô∏è Card data transmitted directly to server. Good for testing/internal use.
                </small>
            </div>
            <div class="mode-option">
                <label>
                    <input type="radio" name="mode" value="token">
                    <strong>Token Mode</strong>
                    <span class="security-badge secure">SECURE</span>
                </label>
                <small>
                    üîí Creates secure Stripe token first. Only tokens transmitted. Recommended for production.
                </small>
            </div>
        </div>

        <div class="form-grid">
            <div class="form-section">
                <h3>Card Information (Test Data)</h3>
                <div class="form-group">
                    <label for="card-name">Name</label>
                    <input type="text" id="card-name" value="John Doe">
                </div>
                <div class="form-group">
                    <label for="card-number">Card Number</label>
                    <input type="text" id="card-number" value="4242424242424242">
                </div>
                <div class="form-group">
                    <label for="exp-month">Expiry Month</label>
                    <input type="text" id="exp-month" value="12">
                </div>
                <div class="form-group">
                    <label for="exp-year">Expiry Year</label>
                    <input type="text" id="exp-year" value="2028">
                </div>
                <div class="form-group">
                    <label for="cvv">CVV</label>
                    <input type="text" id="cvv" value="123">
                </div>
                <div class="form-group">
                    <label for="postal-code">Postal Code</label>
                    <input type="text" id="postal-code" value="12345">
                </div>
            </div>

            <div class="form-section">
                <h3>Browser Environment</h3>
                <div class="form-group">
                    <label for="user-agent">User Agent</label>
                    <textarea id="user-agent"
                        rows="4">Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/108.0.0.0 Safari/537.36</textarea>
                </div>
                <div class="form-group">
                    <label for="vp-width">Viewport Width</label>
                    <input type="number" id="vp-width" value="1920">
                </div>
                <div class="form-group">
                    <label for="vp-height">Viewport Height</label>
                    <input type="number" id="vp-height" value="1080">
                </div>
            </div>
        </div>

        <button id="start-simulation">Start Simulation</button>

        <h2>API Result</h2>
        <div id="api-result">Awaiting simulation...</div>
    </div>

    <script src="https://js.stripe.com/v3/"></script>
    <script>
        // Initialize Stripe for token mode
        const stripe = Stripe('pk_test_51Rzto2IB6C8gCmfgSMCWCdVZfkL5BTqtaUmNhhLLNG6h0wv1OsVr5qB3ioKf5DIVy3bEx4PAC7tYp999urmmKLfT000x8CJ9kd');

        // Mode Selection Handler
        class ModeSelector {
            constructor() {
                this.currentMode = 'direct'; // Default to direct mode
                this.setupModeListeners();
            }

            setupModeListeners() {
                const modeRadios = document.querySelectorAll('input[name="mode"]');
                modeRadios.forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        this.currentMode = e.target.value;
                        this.updateUI();
                    });
                });
            }

            updateUI() {
                const cardSection = document.querySelector('.form-section h3');
                if (this.currentMode === 'token') {
                    cardSection.innerHTML = 'Card Information (For Token Creation) üîí';
                } else {
                    cardSection.innerHTML = 'Card Information (Test Data)';
                }
            }

            async createToken(cardInfo) {
                try {
                    // Since Stripe requires Elements for security, we'll simulate token creation
                    // In a real implementation, this would use server-side token creation
                    // For now, we'll create a mock token that represents the card data securely

                    // Validate card info first
                    if (!cardInfo.number || !cardInfo.expMonth || !cardInfo.expYear || !cardInfo.cvv) {
                        throw new Error('Missing required card information');
                    }

                    // Create a mock token ID (in real implementation, this would come from Stripe)
                    const tokenId = `tok_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

                    // Extract last 4 digits and determine brand
                    const last4 = cardInfo.number.slice(-4);
                    let brand = 'unknown';
                    if (cardInfo.number.startsWith('4')) brand = 'visa';
                    else if (cardInfo.number.startsWith('5')) brand = 'mastercard';
                    else if (cardInfo.number.startsWith('3')) brand = 'amex';

                    // Simulate token creation delay
                    await new Promise(resolve => setTimeout(resolve, 500));

                    // Return mock token in Stripe format
                    return {
                        id: tokenId,
                        card: {
                            last4: last4,
                            brand: brand,
                            exp_month: parseInt(cardInfo.expMonth),
                            exp_year: parseInt(cardInfo.expYear)
                        },
                        // Store original data for server processing (encrypted in real implementation)
                        _originalData: {
                            name: cardInfo.name,
                            number: cardInfo.number,
                            exp_month: cardInfo.expMonth,
                            exp_year: cardInfo.expYear,
                            cvc: cardInfo.cvv,
                            postal_code: cardInfo.postalCode
                        }
                    };
                } catch (error) {
                    console.error('Token creation error:', error);
                    throw error;
                }
            }

            async createRealPaymentMethod(cardInfo) {
                try {
                    // Validate card info first
                    if (!cardInfo.number || !cardInfo.expMonth || !cardInfo.expYear || !cardInfo.cvv) {
                        throw new Error('Missing required card information');
                    }

                    // Use Stripe test tokens for security (recommended approach)
                    const testToken = this.getStripeTestToken(cardInfo.number);

                    if (testToken) {
                        // Use predefined test token
                        return {
                            id: testToken,
                            card: {
                                last4: cardInfo.number.slice(-4),
                                brand: this.detectCardBrand(cardInfo.number),
                                exp_month: parseInt(cardInfo.expMonth),
                                exp_year: parseInt(cardInfo.expYear)
                            },
                            real_payment_method: true,
                            _useTestToken: true
                        };
                    } else {
                        // Fallback to card data (requires special Stripe account setup)
                        return {
                            id: 'real_card_data',
                            card: {
                                last4: cardInfo.number.slice(-4),
                                brand: this.detectCardBrand(cardInfo.number),
                                exp_month: parseInt(cardInfo.expMonth),
                                exp_year: parseInt(cardInfo.expYear)
                            },
                            real_payment_method: true,
                            _cardData: cardInfo
                        };
                    }
                } catch (error) {
                    console.error('Real PaymentMethod preparation error:', error);
                    throw error;
                }
            }

            getStripeTestToken(cardNumber) {
                // Stripe predefined test tokens for common test cards
                const testTokens = {
                    '4242424242424242': 'tok_visa',           // Visa
                    '4000056655665556': 'tok_visa_debit',     // Visa Debit
                    '5555555555554444': 'tok_mastercard',     // Mastercard
                    '2223003122003222': 'tok_mastercard',     // Mastercard (2-series)
                    '5200828282828210': 'tok_mastercard_debit', // Mastercard Debit
                    '378282246310005': 'tok_amex',            // American Express
                    '371449635398431': 'tok_amex',            // American Express
                    '6011111111111117': 'tok_discover',       // Discover
                    '30569309025904': 'tok_diners',           // Diners Club
                    '3566002020360505': 'tok_jcb'             // JCB
                };

                return testTokens[cardNumber.replace(/\s/g, '')];
            }

            detectCardBrand(cardNumber) {
                const number = cardNumber.replace(/\s/g, '');
                if (number.startsWith('4')) return 'visa';
                if (number.startsWith('5') || (number.startsWith('2') && number.length === 16)) return 'mastercard';
                if (number.startsWith('3')) return 'amex';
                if (number.startsWith('6')) return 'discover';
                return 'unknown';
            }
        }

        // Secure Request Builder
        class SecureRequestBuilder {
            static buildTokenRequest(token, cardholderName, browserEnv) {
                return {
                    stripeToken: token.id,
                    cardholderName: cardholderName,
                    browserEnv: browserEnv,
                    tokenMetadata: {
                        last4: token.card.last4,
                        brand: token.card.brand,
                        exp_month: token.card.exp_month,
                        exp_year: token.card.exp_year
                    }
                };
            }

            static buildDirectRequest(cardInfo, browserEnv) {
                return {
                    cardInfo: cardInfo,
                    browserEnv: browserEnv,
                    fingerprintOptions: {
                        useStealth: true
                    }
                };
            }
        }

        // Error Handler
        class ErrorHandler {
            static displayError(resultDiv, error, mode) {
                const errorMessage = `‚ùå ${mode.toUpperCase()} MODE ERROR: ${error.message}`;
                resultDiv.textContent = errorMessage;
                resultDiv.style.backgroundColor = '#f8d7da';
                resultDiv.style.color = '#721c24';
                resultDiv.style.border = '1px solid #f5c6cb';
            }

            static displaySuccess(resultDiv, result) {
                resultDiv.textContent = JSON.stringify(result, null, 2);
                resultDiv.style.backgroundColor = '#d4edda';
                resultDiv.style.color = '#155724';
                resultDiv.style.border = '1px solid #c3e6cb';
            }

            static displayProgress(resultDiv, message) {
                resultDiv.textContent = message;
                resultDiv.style.backgroundColor = '#d1ecf1';
                resultDiv.style.color = '#0c5460';
                resultDiv.style.border = '1px solid #bee5eb';
            }
        }

        // Initialize mode selector
        const modeSelector = new ModeSelector();

        document.getElementById('start-simulation').addEventListener('click', async () => {
            const resultDiv = document.getElementById('api-result');
            const mode = modeSelector.currentMode;

            ErrorHandler.displayProgress(resultDiv, `üîÑ ${mode.toUpperCase()} MODE: Simulation in progress...`);

            // Collect card information
            const cardInfo = {
                name: document.getElementById('card-name').value,
                number: document.getElementById('card-number').value,
                expMonth: document.getElementById('exp-month').value,
                expYear: document.getElementById('exp-year').value,
                cvv: document.getElementById('cvv').value,
                postalCode: document.getElementById('postal-code').value
            };

            // Get transaction type
            const transactionType = document.querySelector('input[name="transaction-type"]:checked').value;

            // Collect browser environment
            const browserEnv = {
                userAgent: document.getElementById('user-agent').value,
                viewport: {
                    width: parseInt(document.getElementById('vp-width').value, 10),
                    height: parseInt(document.getElementById('vp-height').value, 10)
                }
            };

            try {
                let payload;
                let apiEndpoint;

                if (transactionType === 'real') {
                    // Real Transaction Mode
                    ErrorHandler.displayProgress(resultDiv, 'üí∞ REAL TRANSACTION MODE: Processing with real Stripe API...');

                    if (mode === 'token') {
                        // Real Token Mode: Prepare card data for backend processing
                        const cardDataToken = await modeSelector.createRealPaymentMethod(cardInfo);
                        payload = {
                            stripeToken: JSON.stringify(cardDataToken),
                            cardholderName: cardInfo.name,
                            browserEnv: browserEnv
                        };
                    } else {
                        // Real Direct Mode: Send card info for real processing
                        payload = SecureRequestBuilder.buildDirectRequest(cardInfo, browserEnv);
                    }

                    apiEndpoint = '/api/real-payment';
                } else {
                    // Simulation Mode (original behavior)
                    if (mode === 'token') {
                        // Token Mode: Create token first, then send secure request
                        ErrorHandler.displayProgress(resultDiv, 'üîí TOKEN MODE: Creating secure token...');

                        const token = await modeSelector.createToken(cardInfo);

                        ErrorHandler.displayProgress(resultDiv, `‚úÖ Token created successfully (${token.card.brand} ****${token.card.last4})\nüîÑ Sending secure request to server...`);

                        payload = SecureRequestBuilder.buildTokenRequest(token, cardInfo.name, browserEnv);
                    } else {
                        // Direct Mode: Send card info directly (backward compatibility)
                        payload = SecureRequestBuilder.buildDirectRequest(cardInfo, browserEnv);
                    }

                    apiEndpoint = '/api/simulate-payment';
                }

                // Send request to backend API
                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': 'test-api-key' // Must match VALID_API_KEYS in .env
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${result.details || result.error || response.statusText}`);
                }

                // Display success result
                ErrorHandler.displaySuccess(resultDiv, result);

            } catch (error) {
                console.error(`${mode} mode error:`, error);

                // Token mode fallback handling
                if (mode === 'token' && error.message.includes('Token creation failed')) {
                    ErrorHandler.displayError(resultDiv, error, mode);

                    // Suggest fallback to direct mode
                    setTimeout(() => {
                        const fallbackMessage = `${error.message}\n\nüí° SUGGESTION: Try switching to Direct Mode as a fallback option.`;
                        resultDiv.textContent = fallbackMessage;
                    }, 2000);
                } else {
                    ErrorHandler.displayError(resultDiv, error, mode);
                }
            }
        });

        // Initialize UI on page load
        document.addEventListener('DOMContentLoaded', () => {
            modeSelector.updateUI();
        });
    </script>

</body>

</html>